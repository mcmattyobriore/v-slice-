<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VslicR5 - Mobile Edition</title>
<link rel="shortcut icon" type="image/png" href="favicon.png">

<style>
/* Disable text selection & tap highlights */
* {
  -webkit-tap-highlight-color: transparent; /* iOS / Android */
  -webkit-touch-callout: none;              /* iOS long-press menu */
  -webkit-user-select: none;                /* Safari */
  -moz-user-select: none;                   /* Firefox */
  -ms-user-select: none;                    /* IE/Edge */
  user-select: none;                        /* Standard */
}

/* Allow selection ONLY where needed */
textarea, input {
  -webkit-user-select: text;
  user-select: text;
}

/* Prevent focus outlines & mobile glow */
button, canvas, img {
  outline: none;
  -webkit-tap-highlight-color: transparent;
}

/* Prevent iOS rubber-band + double-tap zoom */
html, body {
  overscroll-behavior: none;
  touch-action: manipulation;
}

  body {
    font-family: Arial, sans-serif;
    display: flex;
    gap: 12px;
    background: #111;
    color: #eee;
    margin: 0;
    padding: 10px;
    touch-action: manipulation;
  }
  textarea {
    width: 320px;
    height: 90vh;
    background: #1e1e1e;
    color: #0f0;
    border: 1px solid #444;
    padding: 8px;
    font-family: monospace;
    font-size: 11px;
  }
  .right {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  canvas {
    background: #000;
    border: 1px solid #444;
    width: 100%;
    max-width: 900px;
  }
  button, input[type="file"] {
    background: #222;
    color: #fff;
    border: 1px solid #555;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 4px;
  }
  button:active { background: #444; }
  .row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
  }

  .mobile-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 10px;
    background: #222;
    padding: 15px;
    border-radius: 8px;
  }
  .btn-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
  }
  .pad {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }
  .m-btn {
    width: 60px;
    height: 60px;
    font-size: 24px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
  }
  .opponent-btn {
    background: #900 !important;
    border-color: #f00 !important;
  }
  .player-btn {
    background: #0055ff !important;
    border-color: #3399ff !important;
  }

  @media (max-width: 800px) {
    body { flex-direction: column; }
    textarea { width: 100%; height: 200px; }
  }
.m-btn {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
</style>
<!-- Enable standalone (fullscreen) mode on iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Optional: app title when saved -->
<meta name="apple-mobile-web-app-title" content="VslicR5">
</head>

<body>
<textarea id="jsonInput" spellcheck="false"></textarea>

<div class="right">
  <canvas id="chart" width="900" height="400"></canvas>

  <div class="row">
    <input type="file" accept=".json" onchange="importJSON(this)">
    <input type="file" accept=".ogg,.wav,.mp3,audio/*" onchange="importAudio(this)">
    <button onclick="playAudio()"><img src="play.png"/></button>
    <button onclick="pauseAudio()"><img src="pause.png"/></button>
    <button onclick="stopAudio()"><img src="stop.png"/></button>
  </div>

  <div class="row">
    <button onclick="seekTime(-100)">-100ms</button>
    <button onclick="seekTime(100)">+100ms</button>
    <span id="timeLabel">Time: 0 ms</span>
  </div>

  <div class="mobile-grid">
    <div class="btn-group">
      <small>OPPONENT (WASD)</small>
      <div class="pad">
        <button class="m-btn opponent-btn" onmousedown="addNote(4)">A</button>
        <button class="m-btn opponent-btn" onmousedown="addNote(5)">S</button>
        <button class="m-btn opponent-btn" onmousedown="addNote(6)">W</button>
        <button class="m-btn opponent-btn" onmousedown="addNote(7)">D</button>
      </div>
    </div>
    <div class="btn-group">
      <small>PLAYER (Arrows)</small>
      <div class="pad">
        <button class="m-btn player-btn" onmousedown="addNote(0)"><img src="left.png"/></button>
        <button class="m-btn player-btn" onmousedown="addNote(1)"><img src="down.png"/></button>
        <button class="m-btn player-btn" onmousedown="addNote(2)"><img src="up.png"/></button>
        <button class="m-btn player-btn" onmousedown="addNote(3)"><img src="right.png"/></button>
      </div>
    </div>
  </div>

  <div class="row">
    <button onclick="saveFromJSON()"><img src="save.png"/></button>
    <button onclick="exportJSON()"><img src="export.png"/></button>
  </div>

  <audio id="audio"></audio>
</div>

<script>
const jsonInput = document.getElementById("jsonInput");
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");
const timeLabel = document.getElementById("timeLabel");
const audio = document.getElementById("audio");

let chartData;
let currentTime = 0;
let playing = false;

const laneColors = ["#ff3333", "#33ff33", "#3399ff", "#bb55ff"];

// Keyboard input
window.addEventListener("keydown", e => {
  if (document.activeElement === jsonInput) return;
  switch(e.key.toLowerCase()) {
    case "arrowleft": addNote(0); break;
    case "arrowdown": addNote(1); break;
    case "arrowup": addNote(2); break;
    case "arrowright": addNote(3); break;
    case "a": addNote(4); break;
    case "s": addNote(5); break;
    case "w": addNote(6); break;
    case "d": addNote(7); break;
    case " ": e.preventDefault(); playing ? pauseAudio() : playAudio(); break;
  }
});

// Default chart
chartData = {
  version: "2.0.0",
  notes: { normal: [] },
  generatedBy: "'VslicR5' - FNF v0.8.0"
};
jsonInput.value = JSON.stringify(chartData, null, 2);

function syncTextarea() {
  jsonInput.value = JSON.stringify(chartData, null, 2);
}

function importJSON(input) {
  const file = input.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = e => {
    chartData = JSON.parse(e.target.result);
    syncTextarea();
    drawChart();
  };
  r.readAsText(file);
}

function importAudio(input) {
  const file = input.files[0];
  if (!file) return;
  audio.src = URL.createObjectURL(file);
  audio.load();
  currentTime = 0;
  playing = false;
  timeLabel.textContent = "Time: 0 ms";
  drawChart();
}

function playAudio(){ audio.play(); playing = true; }
function pauseAudio(){ audio.pause(); playing = false; }
function stopAudio(){
  audio.pause();
  audio.currentTime = 0;
  currentTime = 0;
  playing = false;
  drawChart();
}

function seekTime(ms){
  currentTime = Math.max(0, currentTime + ms);
  audio.currentTime = currentTime / 1000;
  timeLabel.textContent = `Time: ${Math.floor(currentTime)} ms`;
  drawChart();
}

audio.addEventListener("timeupdate", () => {
  if (!playing) return;
  currentTime = audio.currentTime * 1000;
  timeLabel.textContent = `Time: ${Math.floor(currentTime)} ms`;
  drawChart();
});

function addNote(lane) {
  chartData.notes.normal.push({
    t: Math.floor(currentTime),
    d: lane,
    l: 0,
    p: []
  });
  chartData.notes.normal.sort((a,b)=>a.t-b.t);
  syncTextarea();
  drawChart();
}

function drawChart() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const centerY = canvas.height / 2;

  for (let i=0;i<8;i++) {
    ctx.strokeStyle="#333";
    ctx.beginPath();
    ctx.moveTo(i*110+50,0);
    ctx.lineTo(i*110+50,canvas.height);
    ctx.stroke();
  }

  for (const n of chartData.notes.normal) {
    const x = n.d * 110 + 50;
    const y = centerY - (n.t - currentTime) * 0.5;
    if (y < -50 || y > canvas.height + 50) continue;

    const c = laneColors[n.d % 4];
    if (n.d <= 3) {
      ctx.fillStyle = c;
      ctx.fillRect(x-15,y-15,30,30);
    } else {
      ctx.strokeStyle = c;
      ctx.lineWidth = 4;
      ctx.strokeRect(x-15,y-15,30,30);
    }
  }
}

drawChart();
</script>
</body>
</html>
