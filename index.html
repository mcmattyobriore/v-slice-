<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FNF JSON Chart Editor (Advanced)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    display: flex;
    gap: 12px;
    background: #111;
    color: #eee;
    margin: 0;
    padding: 10px;
  }
  textarea {
    width: 420px;
    height: 90vh;
    background: #1e1e1e;
    color: #0f0;
    border: 1px solid #444;
    padding: 8px;
    font-family: monospace;
    font-size: 12px;
  }
  .right {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  canvas {
    background: #000;
    border: 1px solid #444;
  }
  button, input[type="file"] {
    background: #222;
    color: #fff;
    border: 1px solid #555;
    padding: 6px 10px;
    cursor: pointer;
  }
  button:hover {
    background: #333;
  }
  .row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
  }
  .previewWrap {
    display: flex;
    gap: 8px;
  }
</style>
</head>
<body>

<textarea id="jsonInput"></textarea>

<div class="right">
  <canvas id="chart" width="900" height="400"></canvas>

  <div class="row">
    <input type="file" accept=".json" onchange="importJSON(this)">
    <input type="file" accept=".ogg" onchange="loadAudio(this)">
    <button onclick="playAudio()">Play</button>
    <button onclick="pauseAudio()">Pause</button>
    <button onclick="stopAudio()">Stop</button>
  </div>

  <div class="row">
    <button onclick="seekTime(-100)">-100ms</button>
    <button onclick="seekTime(100)">+100ms</button>
    <span id="timeLabel">Time: 0 ms</span>
  </div>

  <div class="row">
    <button onclick="saveFromJSON()">ðŸ’¾ Save</button>
    <button onclick="exportJSON()">ðŸ“¤ Export JSON</button>
  </div>

  <strong>Player (0â€“3)</strong>
  <div class="row">
    <button onclick="addNote(0)">â¬…</button>
    <button onclick="addNote(1)">â¬‡</button>
    <button onclick="addNote(2)">â¬†</button>
    <button onclick="addNote(3)">âž¡</button>
  </div>

  <strong>Opponent (4â€“7)</strong>
  <div class="row">
    <button onclick="addNote(4)">â¬…</button>
    <button onclick="addNote(5)">â¬‡</button>
    <button onclick="addNote(6)">â¬†</button>
    <button onclick="addNote(7)">âž¡</button>
  </div>

  <strong>Sprite Previews (PNG + XML)</strong>
  <div class="previewWrap">
    <div>
      <div>Player</div>
      <input type="file" accept=".png" onchange="loadSprite(event,'player')">
      <input type="file" accept=".xml" onchange="loadXML(event,'player')">
      <canvas id="playerPreview" width="150" height="150"></canvas>
    </div>
    <div>
      <div>Opponent</div>
      <input type="file" accept=".png" onchange="loadSprite(event,'opponent')">
      <input type="file" accept=".xml" onchange="loadXML(event,'opponent')">
      <canvas id="opponentPreview" width="150" height="150"></canvas>
    </div>
  </div>
</div>

<audio id="audio"></audio>

<script>
const jsonInput = document.getElementById("jsonInput");
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");
const timeLabel = document.getElementById("timeLabel");
const audio = document.getElementById("audio");

let chartData;
let currentTime = 0;
let playing = false;

const laneColors = [
  "#ff3333", // red
  "#33ff33", // green
  "#3399ff", // blue
  "#bb55ff"  // purple
];

// ---------------- DEFAULT JSON ----------------
chartData = {
  version: "2.0.0",
  notes: { "easy": [],
    "normal": [],
    "hard": [] }
};
jsonInput.value = JSON.stringify(chartData, null, 2);

// ---------------- JSON ----------------
function syncTextarea() {
  jsonInput.value = JSON.stringify(chartData, null, 2);
}

function saveFromJSON() {
  try {
    chartData = JSON.parse(jsonInput.value);
    drawChart();
  } catch {
    alert("Invalid JSON");
  }
}

function exportJSON() {
  const blob = new Blob([JSON.stringify(chartData, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chart.json";
  a.click();
}

function importJSON(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    chartData = JSON.parse(e.target.result);
    syncTextarea();
    drawChart();
  };
  reader.readAsText(file);
}

// ---------------- AUDIO ----------------
function loadAudio(input) {
  audio.src = URL.createObjectURL(input.files[0]);
}
function playAudio(){ audio.play(); playing = true; }
function pauseAudio(){ audio.pause(); playing = false; }
function stopAudio(){
  audio.pause();
  audio.currentTime = 0;
  currentTime = 0;
  drawChart();
}
function seekTime(ms){
  currentTime = Math.max(0, currentTime + ms);
  audio.currentTime = currentTime / 1000;
}
audio.addEventListener("timeupdate",()=>{
  if(!playing) return;
  currentTime = audio.currentTime * 1000;
  timeLabel.textContent = `Time: ${Math.floor(currentTime)} ms`;
  drawChart();
});

// ---------------- NOTES ----------------
function addNote(lane) {
  chartData.notes.normal.push({ t: currentTime, d: lane, l: 0 });
  chartData.notes.normal.sort((a,b)=>a.t-b.t);
  syncTextarea();
  drawChart();
}

// ---------------- DRAW ----------------
function drawChart() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const notes = chartData.notes.normal;
  const centerY = canvas.height / 2;

  for(let i=0;i<8;i++){
    ctx.strokeStyle="#333";
    ctx.beginPath();
    ctx.moveTo(i*110+50,0);
    ctx.lineTo(i*110+50,canvas.height);
    ctx.stroke();
  }

  for(const n of notes){
    const x = n.d*110+50;
    const y = centerY - (n.t-currentTime)*0.05;
    if(y<-50||y>canvas.height+50) continue;

    const baseColor = laneColors[n.d % 4];

    // HOLD TRAIL
    if(n.l > 0){
      ctx.globalAlpha = 0.6;
      ctx.fillStyle = baseColor;
      ctx.fillRect(x-6, y, 12, n.l*0.05);
      ctx.globalAlpha = 1;
    }

    if(n.d <= 3){
      ctx.fillStyle = baseColor;
      ctx.fillRect(x-12,y-12,24,24);
    } else {
      ctx.strokeStyle = baseColor;
      ctx.lineWidth = 3;
      ctx.strokeRect(x-12,y-12,24,24);
    }
  }
}

// ---------------- SPRITE PREVIEW ----------------
const sprites = {
  player:{ img:null, xml:null },
  opponent:{ img:null, xml:null }
};

function loadSprite(e,type){
  const img = new Image();
  img.onload=()=>sprites[type].img=img;
  img.src=URL.createObjectURL(e.target.files[0]);
}

function loadXML(e,type){
  const r=new FileReader();
  r.onload=ev=>sprites[type].xml=ev.target.result;
  r.readAsText(e.target.files[0]);
}

setInterval(()=>{
  ["player","opponent"].forEach(type=>{
    const c=document.getElementById(type+"Preview");
    const ctxp=c.getContext("2d");
    ctxp.clearRect(0,0,c.width,c.height);
    if(sprites[type].img){
      ctxp.drawImage(sprites[type].img,0,0,64,64,43,43,64,64);
    }
  });
},200);

drawChart();
</script>
</body>
</html>
